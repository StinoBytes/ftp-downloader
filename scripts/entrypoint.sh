#!/bin/bash

set -e

echo '                        $$$$$$\    $$\     $$\                   $$\'
echo '                       $$  __$$\   $$ |    \__|                  $  |'
echo '                       $$ /  \__|$$$$$$\   $$\ $$$$$$$\   $$$$$$\\_/$$$$$$$\'
echo '                       \$$$$$$\  \_$$  _|  $$ |$$  __$$\ $$  __$$\ $$  _____|'
echo '                        \____$$\   $$ |    $$ |$$ |  $$ |$$ /  $$ |\$$$$$$\'
echo '                       $$\   $$ |  $$ |$$\ $$ |$$ |  $$ |$$ |  $$ | \____$$\'
echo '                       \$$$$$$  |  \$$$$  |$$ |$$ |  $$ |\$$$$$$  |$$$$$$$  |'
echo '                        \______/    \____/ \__|\__|  \__| \______/ \_______/'
echo '                              ____________________________________________________'
echo '               (>_____.----'\''||          $$$$$$$$\ $$$$$$$$\ $$$$$$$\              |'
echo '                /           ||          $$  _____|\__$$  __|$$  __$$\             |'
echo '               |---.   = /  ||          $$ |         $$ |   $$ |  $$ |            |'
echo '               |    |  ( '\''  ||          $$$$$\       $$ |   $$$$$$$  |            |'
echo '               |    |   `   ||          $$  __|      $$ |   $$  ____/             |'
echo '               |---'\''        ||          $$ |         $$ |   $$ |                  |'
echo '               |            ||          $$ |         $$ |   $$ |                  |'
echo '               [    ________||__________\__|_________\__|___\__|__________________|'
echo '               [__.'\''.---.   |[Y__Y__Y__Y__Y__Y__Y__Y__Y__Y__Y__Y__Y__Y__Y__Y__Y__Y]'
echo '               [   //.-.\\__| `.__//.-.\\//.-.\\_________________//.-.\\//.-.\\_.'\'
echo '               [__/( ( ) )`      '\''( ( ) )( ( ) )`               '\''( ( ) )( ( ) )`'
echo '             -------`---'\''----------`---'\''--`---'\''-------------------`---'\''--`---'\''------'
echo ' $$$$$$$\                                    $$\                           $$\'
echo ' $$  __$$\                                   $$ |                          $$ |'
echo ' $$ |  $$ | $$$$$$\  $$\  $$\  $$\ $$$$$$$\  $$ | $$$$$$\   $$$$$$\   $$$$$$$ | $$$$$$\   $$$$$$\'
echo ' $$ |  $$ |$$  __$$\ $$ | $$ | $$ |$$  __$$\ $$ |$$  __$$\  \____$$\ $$  __$$ |$$  __$$\ $$  __$$\'
echo ' $$ |  $$ |$$ /  $$ |$$ | $$ | $$ |$$ |  $$ |$$ |$$ /  $$ | $$$$$$$ |$$ /  $$ |$$$$$$$$ |$$ |  \__|'
echo ' $$ |  $$ |$$ |  $$ |$$ | $$ | $$ |$$ |  $$ |$$ |$$ |  $$ |$$  __$$ |$$ |  $$ |$$   ____|$$ |'
echo ' $$$$$$$  |\$$$$$$  |\$$$$$\$$$$  |$$ |  $$ |$$ |\$$$$$$  |\$$$$$$$ |\$$$$$$$ |\$$$$$$$\ $$ |'
echo ' \_______/  \______/  \_____\____/ \__|  \__|\__| \______/  \_______| \_______| \_______|\__|'
echo ''

/app/init.sh

if [ -z "$FTP_HOST" ] || [ -z "$FTP_USER" ] || [ -z "$FTP_PASS" ]; then
  echo "Error: FTP_HOST, FTP_USER, and FTP_PASS must be set"
  exit 1
fi

echo "Performing initial download check at startup..."
/app/mirror.sh

if [ -n "$DOWNLOAD_HOURS" ]; then
  echo "Setting download schedule for hours: $DOWNLOAD_HOURS"

  if [[ $DOWNLOAD_HOURS == *-* ]]; then
    START_HOUR=$(echo "$DOWNLOAD_HOURS" | cut -d'-' -f1)
    CRON_EXPR="0 $START_HOUR * * *"
  fi

  echo "$CRON_EXPR /app/mirror.sh >> /var/log/cron.log 2>&1" >/etc/crontabs/root
  mkdir -p /var/log
  touch /var/log/cron.log
  tail -f /var/log/cron.log &
fi

tail -f /dev/null

exec "$@"
